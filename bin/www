#!/usr/bin/env node

/**
 * Server entry point
 *
 * Initializes and starts the HTTPS server with SSL/TLS certificates.
 * Handles port normalization, error handling, and server listening events.
 */

/**
 * Module dependencies
 */
import app from '../app.js';
import debug from 'debug';
import https from 'https';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const debugLog = debug('guibert-denis-creationapi--russelmarina:server');

/**
 * Normalize and configure server port
 *
 * Gets port from environment variable HTTPS_PORT or defaults to '3443'.
 * Sets the port in Express application.
 */
const port = normalizePort(process.env.HTTPS_PORT || '3443');
app.set('port', port);

/**
 * SSL/TLS certificate configuration
 *
 * Loads private key and certificate files from paths specified in environment variables
 * (SSL_KEY_PATH and SSL_CERT_PATH) or defaults to certificates directory.
 * This enables HTTPS connections.
 */
const sslKeyPath = process.env.SSL_KEY_PATH || path.join(__dirname, '../certificates/private-key.pem');
const sslCertPath = process.env.SSL_CERT_PATH || path.join(__dirname, '../certificates/certificate.pem');

const options = {
  key: fs.readFileSync(sslKeyPath),
  cert: fs.readFileSync(sslCertPath),
};

/**
 * Create HTTPS server
 *
 * Creates an HTTPS server instance with SSL/TLS certificates and Express app.
 */

const server = https.createServer(options, app);

/**
 * Start server and attach event listeners
 *
 * Starts listening on the configured port and attaches error and listening event handlers.
 */
server.listen(port);
server.on('error', onError);
server.on('listening', onListening);

/**
 * Normalize a port into a number, string, or false.
 *
 * Converts a port value (string or number) to a valid port number.
 * Returns the original value if it's a named pipe, or false if invalid.
 *
 * @function normalizePort
 * @param {string|number} val - Port value to normalize
 * @returns {number|string|false} Normalized port number, named pipe string, or false if invalid
 */
function normalizePort(val) {
  const port = parseInt(val, 10);

  if (isNaN(port)) {
    // named pipe
    return val;
  }

  if (port >= 0) {
    // port number
    return port;
  }

  return false;
}

/**
 * Event listener for HTTPS server "error" event.
 *
 * @function onError
 * @param {Error} error - Error object from the server
 * @throws {Error} Re-throws error if it's not a listen error
 */
function onError(error) {
  if (error.syscall !== 'listen') {
    throw error;
  }

  const bind = typeof port === 'string' ? 'Pipe ' + port : 'Port ' + port;

  switch (error.code) {
    case 'EACCES':
      console.error(bind + ' requires elevated privileges');
      process.exit(1);
      break;
    case 'EADDRINUSE':
      console.error(bind + ' is already in use');
      process.exit(1);
      break;
    default:
      throw error;
  }
}

/**
 * Event listener for HTTPS server "listening" event.
 *
 * Logs the server address and port when the server starts listening.
 * Uses debug logging for development purposes.
 */
function onListening() {
  const addr = server.address();
  const bind = typeof addr === 'string' ? 'pipe ' + addr : 'port ' + addr.port;
  debugLog('Listening on ' + bind);
}
